<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import jsSHA from 'jssha'
import 'css-doodle'
import { computeTxId, computeBlockHash } from '../bitcoin-hash-tools'

const canvasSize = 30
const codeSize = 1.6
const defaultMsg = 'Hello World'

const message = ref(defaultMsg)
const hashHex = ref(null)
const map = ref(null)
const doodle = ref(null)

const doodleCSS = computed(() => {
  let rgbStr = map.value ? map.value.map( i => i.color ).join(',') : ''
  let bgStr = map.value ? map.value.map( i => i.background ).join(',') : ''
  let unicodeStr = map.value ? map.value.map( i => i.operator ).join(',') : ''
  let css = `
    :doodle {
      @grid: 8 / ${canvasSize}rem;
    }
    background: @pick-n(${bgStr});
    :after {
      content: @pick-n(${unicodeStr});
      color: @pick-n(${rgbStr});
      font-size: ${codeSize}rem;
      font-weight: 900;
    }
  `
  return css
})

const hash = (msg) => {
  const hashFn = new jsSHA("SHA-256", "TEXT", { encoding: "UTF8", numRounds: 2 })
  hashFn.update(msg)
  return hashFn.getHash('HEX')
}
const update = (value) => {
  if (!value) {
    hashHex.value = hash(defaultMsg)
  } else {
    hashHex.value = hash(value)
  }
  //let blockHashHex = '00000020895c61f86457caa36205405cce3267f8184b34f8b693040000000000000000009feb6f57b15efd6f5e1f7fa81fff7b04f2e1a798e3b932b5b62b966ae8771e20a3085e6401dd05175def5624'
  //hashHex.value = computeBlockHash(blockHashHex)
  let transactionHex = '02000000000101ae127cc44f2906402b8dfaca57140eaf8b5b8ede686afa92583d3d89454cb2800000000000fdffffff6522020000000000002251200f7271f8b687fd7d4cb82c690630295b13af80348c8862f900d1b41001f11ac3c8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc8140000000000002251203061ee958f82db94b57c4f3d4136259be464616f26b9df5765bab378ae64d4afc057030000000000160014213e77bedf03500c2bafaa425e0f51be371a9c3b0340e3199c8dbca0d1a803a7e34bb1d28af06a7d159f3c8c73a7650a338ead845a8da95d504134a7b81e3996ab5c2cbd735252768fd74d2dcfcef77229d312cea5958820117f692257b2331233b5705ce9c682be8719ff1b2b64cbca290bd6faeb54423eac06ede2400f8801750063036f7264010118746578742f706c61696e3b636861727365743d7574662d38003a7b2270223a226272632d3230222c226f70223a226d696e74222c227469636b223a2273617473222c22616d74223a22313030303030303030227d6821c0117f692257b2331233b5705ce9c682be8719ff1b2b64cbca290bd6faeb54423e00000000'
  hashHex.value = computeTxId(transactionHex)
  map.value = hashHex.value.split('').map( i => {
    let h = hash(i)
    let rgb = h.slice(0, 6)
    let bg = h.slice(-6)
    let unicode = `22${h.slice(4, 6)}`
    return {
      color: `#${rgb}`,
      background: `#${bg}`,
      operator: `\\${unicode}`,
    }
  } )
  doodle.value.update(doodleCSS.value)
}
const download = async () => {
  let result = await doodle.value.export({
    scale: 1,
    download: false
  })
  const parser = new DOMParser()
  const svg = parser.parseFromString(result.svg, 'image/svg+xml').querySelector('svg')
  const serializer = new XMLSerializer()
  const link = document.createElement('a');
  let svgString, dataURL

  svg.style.width = '300px'
  svg.style.height = '300px'
  svgString = serializer.serializeToString(svg)
  dataURL = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
  
  link.href = dataURL;
  link.download = hashHex.value;
  link.click();
}


watch(message, (currentValue, oldValue) => {
  update(currentValue)
})

onMounted(async () => {
  update(message.value)
})
</script>
<template>
  <div>
    <h1>
      Bitcoin Hash
    </h1>
    <h4>
      Inspired by SHA256
    </h4>
    <div>
      <css-doodle ref="doodle" style="margin: 0 auto;" id="hashimage">
        {{ doodleCSS }}
      </css-doodle>
    </div>
    <div>
      <p>
        Message
      </p>
      <input v-model="message" :placeholder="defaultMsg" />
    </div>
    <div>
      <p>
        Hash
      </p>
      <p>
        {{ hashHex }}
      </p>
    </div>
    <div>
      <button @click="download">
        Download
      </button>
    </div>
  </div>
</template>
<style scoped>
</style>